version: "3.9"

name: skyagentos

x-common-env: &common-env
  OPENROUTER_API_KEY: ${OPENROUTER_API_KEY}
  NVIDIA_API_KEY: ${NVIDIA_API_KEY}
  OPENAI_API_KEY: ${OPENAI_API_KEY}
  LITELLM_MASTER_KEY: ${LITELLM_MASTER_KEY:-skyagentos-dev-key}
  SKYVERN_BASE_URL: ${SKYVERN_BASE_URL:-http://skyvern:8000}
  SKYVERN_API_KEY: ${SKYVERN_API_KEY:-}
  SKYVERN_TASK_ENDPOINT: ${SKYVERN_TASK_ENDPOINT:-/api/v1/tasks}
  LITELLM_BASE_URL: http://litellm:4000
  MEMORY_DB_PATH: /data/memory/skyagentos.db
  MCP_WORKSPACE_PATH: /workspace/shared
  OTEL_EXPORTER_OTLP_ENDPOINT: http://otel-collector:4318
  OTEL_EXPORTER_OTLP_PROTOCOL: http/protobuf
  PYTHONPATH: /app/src
  DESKTOP_DAEMON_URL: http://desktop-daemon:8890

services:
  litellm:
    image: ghcr.io/berriai/litellm:main-stable
    container_name: skyagentos-litellm
    command: ["--config", "/app/config/litellm_config.yaml", "--port", "4000"]
    ports: ["4000:4000"]
    environment:
      <<: *common-env
    volumes:
      - ./litellm_config.yaml:/app/config/litellm_config.yaml:ro
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:4000/health/readiness"]
      interval: 20s
      timeout: 5s
      retries: 10

  ollama:
    image: ollama/ollama:latest
    container_name: skyagentos-ollama
    ports: ["11434:11434"]
    volumes: ["ollama_data:/root/.ollama"]

  skyvern-postgres:
    image: postgres:16
    container_name: skyagentos-skyvern-postgres
    environment:
      POSTGRES_USER: ${SKYVERN_DB_USER:-skyvern}
      POSTGRES_PASSWORD: ${SKYVERN_DB_PASSWORD:-skyvern}
      POSTGRES_DB: ${SKYVERN_DB_NAME:-skyvern}
    volumes:
      - skyvern_pg_data:/var/lib/postgresql/data

  skyvern:
    image: ghcr.io/skyvern-ai/skyvern:latest
    container_name: skyagentos-skyvern
    ports: ["8000:8000"]
    environment:
      <<: *common-env
      DATABASE_STRING: postgresql+psycopg://${SKYVERN_DB_USER:-skyvern}:${SKYVERN_DB_PASSWORD:-skyvern}@skyvern-postgres:5432/${SKYVERN_DB_NAME:-skyvern}
      ENABLE_OPENAI_COMPATIBLE_ROUTING: "true"
      LLM_API_BASE: http://litellm:4000/v1
      LLM_MODEL: vision_executor
      LLM_API_KEY: ${LITELLM_MASTER_KEY:-skyagentos-dev-key}
    volumes:
      - browser_artifacts:/var/lib/skyvern
    depends_on:
      litellm:
        condition: service_healthy
      skyvern-postgres:
        condition: service_started

  mcp-workspace:
    build:
      context: .
      dockerfile: orchestrator/Dockerfile
    container_name: skyagentos-mcp-workspace
    command: ["python", "mcp_workspace_server.py"]
    environment:
      <<: *common-env
    volumes:
      - ./mcp_workspace_server.py:/app/mcp_workspace_server.py:ro
      - ./src:/app/src:ro
      - shared_workspace:/workspace/shared
      - memory_data:/data/memory

  orchestrator:
    build:
      context: .
      dockerfile: orchestrator/Dockerfile
    container_name: skyagentos-orchestrator
    command: ["python", "main_orchestrator.py", "serve"]
    environment:
      <<: *common-env
      ORCHESTRATOR_PORT: 8787
      MAX_SELF_CORRECTIONS: ${MAX_SELF_CORRECTIONS:-3}
      SKYAGENT_OBJECTIVE: ${SKYAGENT_OBJECTIVE:-Research cloud GPU pricing trends and produce a sourced summary}
    ports: ["8787:8787"]
    volumes:
      - ./main_orchestrator.py:/app/main_orchestrator.py:ro
      - ./mcp_workspace_server.py:/app/mcp_workspace_server.py:ro
      - ./src:/app/src:ro
      - shared_workspace:/workspace/shared
      - memory_data:/data/memory
    depends_on:
      litellm:
        condition: service_healthy
      skyvern:
        condition: service_started
      desktop-daemon:
        condition: service_started

  openclaw-gateway:
    image: ghcr.io/openclaw/openclaw-gateway:2026.2.19
    container_name: skyagentos-openclaw
    ports: ["3333:3333"]
    environment:
      <<: *common-env
      OPENCLAW_SKILLS_PATH: /workspace/skills
      OPENCLAW_OTEL_MIGRATION: v2
      OTEL_SERVICE_NAME: openclaw-gateway
      ORCHESTRATOR_API_URL: http://orchestrator:8787/missions
      OPENCLAW_WHATSAPP_ENABLED: ${OPENCLAW_WHATSAPP_ENABLED:-true}
      OPENCLAW_TELEGRAM_ENABLED: ${OPENCLAW_TELEGRAM_ENABLED:-true}
    volumes:
      - ./openclaw_skill.js:/workspace/skills/openclaw_skill.js:ro
      - shared_workspace:/workspace/shared
      - memory_data:/data/memory
    depends_on:
      orchestrator:
        condition: service_started
      otel-collector:
        condition: service_started

  otel-collector:
    image: otel/opentelemetry-collector-contrib:0.117.0
    container_name: skyagentos-otel
    command: ["--config=/etc/otelcol-contrib/config.yaml"]
    volumes:
      - ./telemetry/otel-collector.yaml:/etc/otelcol-contrib/config.yaml:ro
    ports: ["4317:4317", "4318:4318", "9464:9464"]

  prometheus:
    image: prom/prometheus:v3.1.0
    container_name: skyagentos-prometheus
    command: ["--config.file=/etc/prometheus/prometheus.yml"]
    volumes:
      - ./telemetry/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    ports: ["9090:9090"]
    depends_on: [otel-collector]

  grafana:
    image: grafana/grafana:11.4.0
    container_name: skyagentos-grafana
    environment:
      GF_SECURITY_ADMIN_USER: ${GF_SECURITY_ADMIN_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GF_SECURITY_ADMIN_PASSWORD:-admin}
    ports: ["3000:3000"]
    volumes: ["grafana_data:/var/lib/grafana"]
    depends_on: [prometheus]

volumes:
  ollama_data:
  browser_artifacts:
  shared_workspace:
  memory_data:
  grafana_data:
  skyvern_pg_data:
